function inC () {

  // TODO externalize the score
  this.score = [
    {
      "number": 1,
      "score": [
        {"pitch": "C4", "velocity": "50", "duration": 0, "grace": true},
        {"pitch": "E4", "velocity": "115", "duration": 2},
        {"pitch": "C4", "velocity": "50", "duration": 0, "grace": true},
        {"pitch": "E4", "velocity": "115", "duration": 2},
        {"pitch": "C4", "velocity": "50", "duration": 0, "grace": true},
        {"pitch": "E4", "velocity": "115", "duration": 2}
      ]
    },
    {
      "number": 2,
      "score": [
        {"pitch": "C4", "velocity": "50", "duration": 0, "grace": true},
        {"pitch": "E4", "velocity": "115", "duration": 1},
        {"pitch": "F4", "velocity": "50", "duration": 1},
        {"pitch": "E4", "velocity": "85", "duration": 2}
      ]
    },
    {
      "number": 3,
      "score": [
        {"duration": 1},
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "F4", "velocity": "85", "duration": 1},
        {"pitch": "E4", "velocity": "50", "duration": 1}
      ]
    },
    {
      "number": 4,
      "score": [
        {"duration": 1},
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "F4", "velocity": "85", "duration": 1},
        {"pitch": "G4", "velocity": "50", "duration": 1}
      ]
    },
    {
      "number": 5,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 1},
        {"pitch": "F4", "velocity": "50", "duration": 1},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"duration": 1}
      ]
    },
    {
      "number": 6,
      "score": [
        {"pitch": "C5", "velocity": "115", "duration": 8},
        {"pitch": "C5", "velocity": "115", "duration": 8}
      ]
    },
    {
      "number": 7,
      "score": [
        {"duration": 2},
        {"duration": 2},
        {"duration": 2},
        {"duration": 1},
        {"pitch": "C4", "velocity": "115", "duration": 0.5},
        {"pitch": "C4", "velocity": "50", "duration": 0.5},
        {"pitch": "C4", "velocity": "50", "duration": 1},
        {"duration": 1},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2}
      ]
    },
    {
      "number": 8,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 12},
        {"pitch": "F4", "velocity": "85", "duration": 8},
        {"pitch": "F4", "velocity": "85", "duration": 8}
      ]
    },
    {
      "number": 9,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"duration": 1},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2}
      ]
    },
    {
      "number": 10,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 11,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 12,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 1},
        {"pitch": "G4", "velocity": "50", "duration": 1},
        {"pitch": "B4", "velocity": "85", "duration": 8},
        {"pitch": "C5", "velocity": "115", "duration": 2}
      ]
    },
    {
      "number": 13,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 1.5},
        {"pitch": "G4", "velocity": "85", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"duration": 1.5},
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 6}
      ]
    },
    {
      "number": 14,
      "score": [
        {"pitch": "C5", "velocity": "115", "duration": 8},
        {"pitch": "B4", "velocity": "85", "duration": 8},
        {"pitch": "G4", "velocity": "85", "duration": 8},
        {"pitch": "Gb4", "velocity": "85", "duration": 8}
      ]
    },
    {
      "number": 15,
      "score": [
        {"pitch": "G4", "velocity": "115",  "duration": 0.5},
        {"duration": 1.5},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2}
      ]
    },
    {
      "number": 16,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "B4", "velocity": "50", "duration": 0.5},
        {"pitch": "C5", "velocity": "85", "duration": 0.5},
        {"pitch": "B4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 17,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "C5", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "C5", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"duration": 0.5}
      ]
    },
    {
      "number": 18,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 1.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 19,
      "score": [
        {"duration": 3},
        {"pitch": "G5", "velocity": "115", "duration": 3}
      ]
    },
    {
      "number": 20,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "G3", "velocity": "115", "duration": 1.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "85", "duration": 0.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "85", "duration": 0.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 21,
      "score": [
        {"pitch": "Gb4", "velocity": "115", "duration": 6}
      ]
    },
    {
      "number": 22,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 3},
        {"pitch": "E4", "velocity": "85", "duration": 3},
        {"pitch": "E4", "velocity": "85", "duration": 3},
        {"pitch": "E4", "velocity": "85", "duration": 3},
        {"pitch": "E4", "velocity": "85", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "50", "duration": 1}
      ]
    },
    {
      "number": 23,
      "score": [
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "Gb4", "velocity": "115", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 2}
      ]
    },
    {
      "number": 24,
      "score": [
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "Gb4", "velocity": "50", "duration": 1},
        {"pitch": "G4", "velocity": "115", "duration": 3},
        {"pitch": "G4", "velocity" :"85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "50", "duration": 1}
      ]
    },
    {
      "number": 25,
      "score": [
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "Gb4", "velocity": "50", "duration": 1},
        {"pitch": "G4", "velocity": "50", "duration": 1},
        {"pitch": "A4", "velocity": "115", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3}
      ]
    },
    {
      "number": 26,
      "score": [
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "Gb4", "velocity": "50", "duration": 1},
        {"pitch": "G4", "velocity": "50", "duration": 1},
        {"pitch": "A4", "velocity": "50", "duration": 1},
        {"pitch": "B4", "velocity": "115", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3}
      ]
    },
    {
      "number": 27,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "G4", "velocity": "115", "duration": 1},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "85", "duration": 0.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "85", "duration": 0.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 28,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "115", "duration": 1.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 29,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 6},
        {"pitch": "G4", "velocity": "85", "duration": 6},
        {"pitch": "C5", "velocity": "85", "duration": 6}
      ]
    },
    {
      "number": 30,
      "score": [
        {"pitch": "C5", "velocity": "115", "duration": 12}
      ]
    },
    {
      "number": 31,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5},
        {"pitch": "G4", "velocity": "85", "duration": 0.5},
        {"pitch": "B4", "velocity": "50", "duration": 0.5},
        {"pitch": "G4", "velocity": "85", "duration": 0.5},
        {"pitch": "B4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 32,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "F4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5},
        {"pitch": "F4", "velocity": "85", "duration": 6},
        {"pitch": "G4", "velocity": "85", "duration": 3}
      ]
    },
    {
      "number": 33,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5},
        {"duration": 1}
      ]
    },
    {
      "number": 34,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 35,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"duration": 1},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2},
        {"pitch": "Bb4", "velocity": "115", "duration": 2},
        {"pitch": "G5", "velocity": "85", "duration": 6},
        {"pitch": "A5", "velocity": "115", "duration": 1},
        {"pitch": "G5", "velocity": "50", "duration": 1},
        {"pitch": "G5", "velocity": "85", "duration": 1},
        {"pitch": "B5", "velocity": "50", "duration": 1},
        {"pitch": "A5", "velocity": "85", "duration": 3},
        {"pitch": "G5", "velocity": "50", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 6},
        {"pitch": "G5", "velocity": "115", "duration": 1},
        {"pitch": "Gb5", "velocity": "50", "duration": 1},
        {"pitch": "Gb5", "velocity": "50", "duration": 6},
        {"duration": 2},
        {"duration": 2},
        {"duration": 1},
        {"pitch": "E5", "velocity": "50", "duration": 1},
        {"pitch": "E5", "velocity": "115", "duration": 4},
        {"pitch": "F5", "velocity": "85", "duration": 12}
      ]
    },
    {
      "number": 36,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 37,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 38,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5}
      ]
    },
    {
      "number": 39,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "F4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "C5", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 40,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 41,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 42,
      "score": [
        {"pitch": "C5", "velocity": "115", "duration": 8},
        {"pitch": "B4", "velocity": "115", "duration": 8},
        {"pitch": "A4", "velocity": "115", "duration": 8},
        {"pitch": "C5", "velocity": "115", "duration": 8}
      ]
    },
    {
      "number": 43,
      "score": [
        {"pitch": "F5", "velocity": "115", "duration": 0.5},
        {"pitch": "E5", "velocity": "50", "duration": 0.5},
        {"pitch": "F5", "velocity": "85", "duration": 0.5},
        {"pitch": "E5", "velocity": "50", "duration": 0.5},
        {"pitch": "E5", "velocity": "115", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "F5", "velocity": "85", "duration": 0.5},
        {"pitch": "E5", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 44,
      "score": [
        {"pitch": "F5", "velocity": "115", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "C5", "velocity": "115", "duration": 2}
      ]
    },
    {
      "number": 45,
      "score": [
        {"pitch": "D5", "velocity": "115", "duration": 2},
        {"pitch": "D5", "velocity": "85", "duration": 2},
        {"pitch": "G4", "velocity": "85", "duration": 2}
      ]
    },
    {
      "number": 46,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "D5", "velocity": "50", "duration": 0.5},
        {"pitch": "E5", "velocity": "85", "duration": 0.5},
        {"pitch": "D5", "velocity": "50", "duration": 0.5},
        {"duration": 1},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"duration": 1},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"duration": 1},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "D5", "velocity": "50", "duration": 0.5},
        {"pitch": "E5", "velocity": "85", "duration": 0.5},
        {"pitch": "D5", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 47,
      "score": [
        {"pitch": "D5", "velocity": "115", "duration": 0.5},
        {"pitch": "E5", "velocity": "50", "duration": 0.5},
        {"pitch": "D5", "velocity": "85", "duration": 1}
      ]
    },
    {
      "number": 48,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 12},
        {"pitch": "G4", "velocity": "115", "duration": 8},
        {"pitch": "F4", "velocity": "115", "duration": 8},
        {"pitch": "F4", "velocity": "85", "duration": 2}
      ]
    },
    {
      "number": 49,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 50,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 51,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "85", "duration": 0.5},
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "85", "duration": 0.5}
      ]
    },
    {
      "number": 52,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 53,
      "score": [
        {"pitch": "Bb4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    }
  ];

  this.performerMock = {
    "461c9669-ef45-33e1-0b7b-a8bd7b6d7eee" : {
      "advanceToPhrase" : 9,
      "channel" : 2,
      "currentPhrase" : 9,
      "instrumentName" : "marimba",
      "nextPhraseStart" : 38
    },
    "b6df1e27-13ab-81dd-4a0f-142cc6e50bb4" : {
      "advanceToPhrase" : 7,
      "channel" : 3,
      "currentPhrase" : 7,
      "instrumentName" : "kalimba",
      "nextPhraseStart" : 32
    },
    "bdf9757b-840c-2f75-be99-738338c75031" : {
      "advanceToPhrase" : 5,
      "channel" : 4,
      "currentPhrase" : 5,
      "instrumentName" : "vibraphone",
      "nextPhraseStart" : 6
    },
    "dcc67053-16f8-936d-a999-d2a1aa37fe4d" : {
      "advanceToPhrase" : 9,
      "channel" : 5,
      "currentPhrase" : 4,
      "instrumentName" : "acoustic_bass",
      "nextPhraseStart" : 10
    },
    "deb656fd-670b-b947-db16-aacdb5ef3201" : {
      "advanceToPhrase" : 12,
      "channel" : 1,
      "currentPhrase" : 9,
      "instrumentName" : "acoustic_grand_piano",
      "nextPhraseStart" : 4
    }
  };

  this.octaveMap = {
    "acoustic_bass"         :-2,
    "acoustic_grand_piano"  :-1,
    "cello"                 :-1,
    "kalimba"               : 1,
    "marimba"               : 0,
    "oboe"                  : 0,
    "vibraphone"            : 1,
    "viola"                 : 0
  };

  this.tempo = 240;
  this.performers = {};
  // TODO store this in local storage so it persists across refreshes
  this.myPerformers = [];
  this.availableChannel = 1;

  var self = this;
  firebase.database().ref("inC").once('value',function(snapshot) {
    var inC = snapshot.val();
    var session = inC.session;
    if (session) {
      self.tempo = inC.tempo;
      self.availableChannel = inC.availableChannel;
      self.performers = inC.performers;
      var syncOnPerformerKey = Object.keys(self.performers).reduce(function(a, b){ return self.performers[a]['nextPhraseStart'] > self.performers[b]['nextPhraseStart'] ? b : a });
      var normalizeToBeatNumber = self.performers[syncOnPerformerKey]['nextPhraseStart'];
      Object.keys(self.performers).forEach(function(performerId) {
        var performer = self.performers[performerId];
        self.performers[performerId]['nextPhraseStart'] = performer['nextPhraseStart'] - (normalizeToBeatNumber - 4);
        // TODO add detection for who owns this performer
        self.setupPerformer(performerId,0);
        MIDI.setVolume(performer.channel, 100);
        MIDI.programChange(performer.channel, MIDI.GM.byName[performer.instrumentName].number);
      });
    }
  });

  firebase.database().ref("inC").on('child_changed',function(snapshot) {
    var key = snapshot.key;
    if (key == 'performers') {
      var remotePerformers = snapshot.val();
      Object.keys(self.performers).forEach(function(performerId) {
        if (remotePerformers[performerId]['advanceToPhrase'] > self.performers[performerId]['currentPhrase'] && remotePerformers[performerId]['advanceToPhrase'] > self.performers[performerId]['advanceToPhrase']) {
          self.advanceToPhrase(performerId,remotePerformers[performerId]['advanceToPhrase']);
        }
      });
    }
  });

  this.newPerformer = function(id,instrument) {
    // If someone is already playing, find out what beat # they're on and join in then.
    var normalizeToBeatNumber;
    if (Object.keys(self.performers).length > 0) {
      var syncOnPerformerKey = Object.keys(self.performers).reduce(function(a, b){
        return self.performers[a]['nextPhraseStart'] > self.performers[b]['nextPhraseStart'] ? b : a
      });
      normalizeToBeatNumber = self.performers[syncOnPerformerKey]['nextPhraseStart'];
    } else {
      normalizeToBeatNumber = 4;
    }
    // otherwise start after a few metronome ticks
    this.performers[id] = {
      "channel":this.availableChannel,
      "instrumentName":instrument,
      "currentPhrase":1,
      "nextPhraseStart":normalizeToBeatNumber,
      "advanceToPhrase":1
    };
    this.myPerformers.push(id);
    // Set up performer audio Channel
    MIDI.setVolume(this.availableChannel, 100);
    MIDI.programChange(this.availableChannel, MIDI.GM.byName[instrument].number);
    this.availableChannel += 1;
    firebase.database().ref("inC/availableChannel").set(this.availableChannel);
    firebase.database().ref("inC/performers").set(this.performers);
    this.setupPerformer(id,1);
  }

  this.setupPerformer = function(id,mine) {
    if (mine) {
      $('.performers').prepend('<div class="player" id="' + id + '"><div class="avatar"></div><div class="advance"><button>Next Phrase</button></div><div class="current"><img src="./images/' + self.performers[id]['currentPhrase'] + '.png" /></div><div class="instrument"></div></div><hr />');
      $('#' + id + ' .avatar').css("background-image","url('https://api.adorable.io/avatars/75/" + id + ".png')");
      $('#' + id + ' .instrument').css("background-image","url('/in-c/images/" + self.performers[id].instrumentName + ".jpg')");
      $('#' + id + ' .advance button').click(function(e){
        e.preventDefault();
        self.advanceByOne(id);
      });
    } else {
      $('.performers').prepend('<div class="player" id="' + id + '"><div class="avatar"></div><div class="advance"></div><div class="current"><img src="./images/' + self.performers[id]['currentPhrase'] + '.png" /></div><div class="instrument"></div></div><hr />');
      $('#' + id + ' .avatar').css("background-image","url('https://api.adorable.io/avatars/75/" + id + ".png')");
      $('#' + id + ' .instrument').css("background-image","url('/in-c/images/" + self.performers[id].instrumentName + ".jpg')");
    }
  };

  this.advanceByOne = function(id) {
    this.performers[id].advanceToPhrase += 1;
    firebase.database().ref("inC/performers").set(this.performers);
  };

  this.advanceToPhrase = function(id,phrase) {
    this.performers[id].advanceToPhrase = phrase;
    firebase.database().ref("inC/performers").set(this.performers);
  };

  this.progressPerformer = function(id) {
    self.performers[id].currentPhrase = self.performers[id].currentPhrase + 1;
    $('#' + id + ' .current img').attr("src", "./images/" + self.performers[id].currentPhrase + ".png");
    if (self.performers[id].currentPhrase > 53) {
      self.removePerformer(id);
    }
    firebase.database().ref("inC/performers").set(this.performers);
  };

  this.removePerformer = function(id) {
    delete this.performers[id];
    $('#' + id + ' .advance button').remove();
    $('#' + id + ' .current img').attr("src", "./images/shh.jpg");
    if (this.performers.length == 0) {
      firebase.database().ref("inC/session").set(0);
    }
    firebase.database().ref("inC/performers").set(this.performers);
  };

  this.init = function() {
    var eighthNoteMilliseconds = 60 * 1000 / this.tempo;

    MIDI.setVolume(0, 60);
    MIDI.programChange(0, MIDI.GM.byName["marimba"].number);

    var self = this;
    var beat = 0;

    var metronome = setInterval(function() {

      Object.keys(self.performers).forEach(function(id){
        if (self.performers[id].nextPhraseStart == beat) {
          if (self.performers[id].advanceToPhrase > self.performers[id].currentPhrase) {
            self.progressPerformer(id);
          }
          var scoreIndex = (self.performers[id].currentPhrase - 1);
          var phraseScore = self.score[scoreIndex].score;
          var phraseInstructions = [];
          var phraseDuration = 0;
          var phraseNoteCount = phraseScore.length;
          var i = 0;

          phraseScore.forEach(function(note) {
            var duration = note.duration;
            var velocity = note.velocity;
            if (note.pitch) {
              var pitchValue = MIDI.keyToNote[note.pitch];
              var noteOn = {
                "type": "on",
                "channel": self.performers[id].channel,
                "pitch": pitchValue,
                "velocity": velocity,
                "duration": duration,
                "targetBeat": phraseDuration * 2,
                "delay": (phraseDuration * eighthNoteMilliseconds + 10) / 1000
              };
              phraseInstructions.push(noteOn);

              var noteOff = {
                "type":"off",
                "channel":self.performers[id].channel,
                "pitch":pitchValue,
                "duration": duration,
                "targetBeat": phraseDuration * 2,
                "delay": (phraseDuration * eighthNoteMilliseconds + (note.grace ? (eighthNoteMilliseconds / 4) : (duration * eighthNoteMilliseconds - 25))) / 1000
              };
              phraseInstructions.push(noteOff);
            }
            phraseDuration += duration;
          });
          self.performers[id].nextPhraseStart = beat + phraseDuration * 2;
          phraseInstructions.forEach(function(instruction) {
            var adjustedPitch = instruction.pitch + (12 * self.octaveMap[self.performers[id].instrumentName]);
            if (instruction.type == "on") {
              MIDI.noteOn(instruction.channel, adjustedPitch, instruction.velocity, instruction.delay);
            } else {
              MIDI.noteOff(instruction.channel, adjustedPitch, instruction.delay);
            }
          });
        }
      });
      if (beat % 2 == 0) {
        MIDI.noteOn(0, 72, 50, 0);
        MIDI.noteOff(0, 72, 0.15);
      }
      beat += 1;
    }, eighthNoteMilliseconds / 2);
  }


  $('.start').click(function(e){
    e.preventDefault();
    self.init();
  });

  $('.add').click(function(e){
    e.preventDefault();
    var insts = ["marimba"];
    var randInst = insts[Math.floor(Math.random()*insts.length)]
    function s4() {
      return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
    }
    var randName = s4() + s4() + '-' + s4() + '-' + s4() + '-' +
      s4() + '-' + s4() + s4() + s4();
    self.newPerformer(randName,randInst);
  });



};

$(document).ready(function() {
	MIDI.loadPlugin({
		soundfontUrl: "./audio/",
		instruments: [ "acoustic_bass","acoustic_grand_piano", "cello","kalimba","marimba","oboe","vibraphone", "viola"],
		onsuccess: function() {
      window.inC = new inC();
		}
	});
});
