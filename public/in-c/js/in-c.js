function inC () {

  // TODO externalize the score
  this.score = [
    {
      "number": 1,
      "score": [
        {"pitch": "C4", "velocity": "50", "duration": 0, "grace": true},
        {"pitch": "E4", "velocity": "115", "duration": 2},
        {"pitch": "C4", "velocity": "50", "duration": 0, "grace": true},
        {"pitch": "E4", "velocity": "115", "duration": 2},
        {"pitch": "C4", "velocity": "50", "duration": 0, "grace": true},
        {"pitch": "E4", "velocity": "115", "duration": 2}
      ]
    },
    {
      "number": 2,
      "score": [
        {"pitch": "C4", "velocity": "50", "duration": 0, "grace": true},
        {"pitch": "E4", "velocity": "115", "duration": 1},
        {"pitch": "F4", "velocity": "50", "duration": 1},
        {"pitch": "E4", "velocity": "85", "duration": 2}
      ]
    },
    {
      "number": 3,
      "score": [
        {"duration": 1},
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "F4", "velocity": "85", "duration": 1},
        {"pitch": "E4", "velocity": "50", "duration": 1}
      ]
    },
    {
      "number": 4,
      "score": [
        {"duration": 1},
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "F4", "velocity": "85", "duration": 1},
        {"pitch": "G4", "velocity": "50", "duration": 1}
      ]
    },
    {
      "number": 5,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 1},
        {"pitch": "F4", "velocity": "50", "duration": 1},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"duration": 1}
      ]
    },
    {
      "number": 6,
      "score": [
        {"pitch": "C5", "velocity": "115", "duration": 8},
        {"pitch": "C5", "velocity": "115", "duration": 8}
      ]
    },
    {
      "number": 7,
      "score": [
        {"duration": 2},
        {"duration": 2},
        {"duration": 2},
        {"duration": 1},
        {"pitch": "C4", "velocity": "115", "duration": 0.5},
        {"pitch": "C4", "velocity": "50", "duration": 0.5},
        {"pitch": "C4", "velocity": "50", "duration": 1},
        {"duration": 1},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2}
      ]
    },
    {
      "number": 8,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 12},
        {"pitch": "F4", "velocity": "85", "duration": 8},
        {"pitch": "F4", "velocity": "85", "duration": 8}
      ]
    },
    {
      "number": 9,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"duration": 1},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2}
      ]
    },
    {
      "number": 10,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 11,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 12,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 1},
        {"pitch": "G4", "velocity": "50", "duration": 1},
        {"pitch": "B4", "velocity": "85", "duration": 8},
        {"pitch": "C5", "velocity": "115", "duration": 2}
      ]
    },
    {
      "number": 13,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 1.5},
        {"pitch": "G4", "velocity": "85", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"duration": 1.5},
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 6}
      ]
    },
    {
      "number": 14,
      "score": [
        {"pitch": "C5", "velocity": "115", "duration": 8},
        {"pitch": "B4", "velocity": "85", "duration": 8},
        {"pitch": "G4", "velocity": "85", "duration": 8},
        {"pitch": "Gb4", "velocity": "85", "duration": 8}
      ]
    },
    {
      "number": 15,
      "score": [
        {"pitch": "G4", "velocity": "115",  "duration": 0.5},
        {"duration": 1.5},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2}
      ]
    },
    {
      "number": 16,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "B4", "velocity": "50", "duration": 0.5},
        {"pitch": "C5", "velocity": "85", "duration": 0.5},
        {"pitch": "B4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 17,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "C5", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "C5", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"duration": 0.5}
      ]
    },
    {
      "number": 18,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 1.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 19,
      "score": [
        {"duration": 3},
        {"pitch": "G5", "velocity": "115", "duration": 3}
      ]
    },
    {
      "number": 20,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "G3", "velocity": "115", "duration": 1.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "85", "duration": 0.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "85", "duration": 0.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 21,
      "score": [
        {"pitch": "Gb4", "velocity": "115", "duration": 6}
      ]
    },
    {
      "number": 22,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 3},
        {"pitch": "E4", "velocity": "85", "duration": 3},
        {"pitch": "E4", "velocity": "85", "duration": 3},
        {"pitch": "E4", "velocity": "85", "duration": 3},
        {"pitch": "E4", "velocity": "85", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocty": "50", "duration": 1}
      ]
    },
    {
      "number": 23,
      "score": [
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "Gb4", "velocity": "115", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "Gb4", "velocity": "85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 2}
      ]
    },
    {
      "number": 24,
      "score": [
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "Gb4", "velocity": "50", "duration": 1},
        {"pitch": "G4", "velocity": "115", "duration": 3},
        {"pitch": "G4", "velocity" :"85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "G4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "50", "duration": 1}
      ]
    },
    {
      "number": 25,
      "score": [
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "Gb4", "velocity": "50", "duration": 1},
        {"pitch": "G4", "velocity": "50", "duration": 1},
        {"pitch": "A4", "velocity": "115", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "A4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3}
      ]
    },
    {
      "number": 26,
      "score": [
        {"pitch": "E4", "velocity": "50", "duration": 1},
        {"pitch": "Gb4", "velocity": "50", "duration": 1},
        {"pitch": "G4", "velocity": "50", "duration": 1},
        {"pitch": "A4", "velocity": "50", "duration": 1},
        {"pitch": "B4", "velocity": "115", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3},
        {"pitch": "B4", "velocity": "85", "duration": 3}
      ]
    },
    {
      "number": 27,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "G4", "velocity": "115", "duration": 1},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "85", "duration": 0.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "85", "duration": 0.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 28,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "85", "duration": 0.5},
        {"pitch": "Gb4", "velocity": "50", "duration": 0.5},
        {"pitch": "E4", "velocity": "115", "duration": 1.5},
        {"pitch": "E4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 29,
      "score": [
        {"pitch": "E4", "velocity": "115", "duration": 6},
        {"pitch": "G4", "velocity": "85", "duration": 6},
        {"pitch": "C5", "velocity": "85", "duration": 6}
      ]
    },
    {
      "number": 30,
      "score": [
        {"pitch": "C5", "velocity": "115", "duration": 12}
      ]
    },
    {
      "number": 31,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5},
        {"pitch": "G4", "velocity": "85", "duration": 0.5},
        {"pitch": "B4", "velocity": "50", "duration": 0.5},
        {"pitch": "G4", "velocity": "85", "duration": 0.5},
        {"pitch": "B4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 32,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "F4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5},
        {"pitch": "F4", "velocity": "85", "duration": 6},
        {"pitch": "G4", "velocity": "85", "duration": 3}
      ]
    },
    {
      "number": 33,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5},
        {"duration": 1}
      ]
    },
    {
      "number": 34,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 35,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"duration": 1},
        {"duration": 2},
        {"duration": 2},
        {"duration": 2},
        {"pitch": "Bb4", "velocity": "115", "duration": 2},
        {"pitch": "G5", "velocity": "85", "duration": 6},
        {"pitch": "A5", "velocity": "115", "duration": 1},
        {"pitch": "G5", "velocity": "50", "duration": 1},
        {"pitch": "G5", "velocity": "85", "duration": 1},
        {"pitch": "B5", "velocity": "50", "duration": 1},
        {"pitch": "A5", "velocity": "85", "duration": 3},
        {"pitch": "G5", "velocity": "50", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 6},
        {"pitch": "G5", "velocity": "115", "duration": 1},
        {"pitch": "Gb5", "velocity": "50", "duration": 1},
        {"pitch": "Gb5", "velocity": "50", "duration": 6},
        {"duration": 2},
        {"duration": 2},
        {"duration": 1},
        {"pitch": "E5", "velocity": "50", "duration": 1},
        {"pitch": "E5", "velocity": "115", "duration": 4},
        {"pitch": "F5", "velocity": "85", "duration": 12}
      ]
    },
    {
      "number": 36,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 37,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 38,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5}
      ]
    },
    {
      "number": 39,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "F4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "B4", "velocity": "85", "duration": 0.5},
        {"pitch": "C5", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 40,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "F4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 41,
      "score": [
        {"pitch": "B4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 42,
      "score": [
        {"pitch": "C5", "velocity": "115", "duration": 8},
        {"pitch": "B4", "velocity": "115", "duration": 8},
        {"pitch": "A4", "velocity": "115", "duration": 8},
        {"pitch": "C5", "velocity": "115", "duration": 8}
      ]
    },
    {
      "number": 43,
      "score": [
        {"pitch": "F5", "velocity": "115", "duration": 0.5},
        {"pitch": "E5", "velocity": "50", "duration": 0.5},
        {"pitch": "F5", "velocity": "85", "duration": 0.5},
        {"pitch": "E5", "velocity": "50", "duration": 0.5},
        {"pitch": "E5", "velocity": "115", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "F5", "velocity": "85", "duration": 0.5},
        {"pitch": "E5", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 44,
      "score": [
        {"pitch": "F5", "velocity": "115", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "E5", "velocity": "85", "duration": 1},
        {"pitch": "C5", "velocity": "115", "duration": 2}
      ]
    },
    {
      "number": 45,
      "score": [
        {"pitch": "D5", "velocity": "115", "duration": 2},
        {"pitch": "D5", "velocity": "85", "duration": 2},
        {"pitch": "G4", "velocity": "85", "duration": 2}
      ]
    },
    {
      "number": 46,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "D5", "velocity": "50", "duration": 0.5},
        {"pitch": "E5", "velocity": "85", "duration": 0.5},
        {"pitch": "D5", "velocity": "50", "duration": 0.5},
        {"duration": 1},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"duration": 1},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"duration": 1},
        {"pitch": "G4", "velocity": "85", "duration": 1},
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "D5", "velocity": "50", "duration": 0.5},
        {"pitch": "E5", "velocity": "85", "duration": 0.5},
        {"pitch": "D5", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 47,
      "score": [
        {"pitch": "D5", "velocity": "115", "duration": 0.5},
        {"pitch": "E5", "velocity": "50", "duration": 0.5},
        {"pitch": "D5", "velocity": "85", "duration": 1}
      ]
    },
    {
      "number": 48,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 12},
        {"pitch": "G4", "velocity": "115", "duration": 8},
        {"pitch": "F4", "velocity": "115", "duration": 8},
        {"pitch": "F4", "velocity": "85", "duration": 2}
      ]
    },
    {
      "number": 49,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "85", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 50,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 51,
      "score": [
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "85", "duration": 0.5},
        {"pitch": "F4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "85", "duration": 0.5}
      ]
    },
    {
      "number": 52,
      "score": [
        {"pitch": "G4", "velocity": "115", "duration": 0.5},
        {"pitch": "Bb4", "velocity": "50", "duration": 0.5}
      ]
    },
    {
      "number": 53,
      "score": [
        {"pitch": "Bb4", "velocity": "115", "duration": 0.5},
        {"pitch": "G4", "velocity": "50", "duration": 0.5}
      ]
    }
  ];

  this.performerMock = {
    "6ac5816b-d392-bf0f-7b14-8469da9ff2c5" : {
      "advancePhrase" : 0,
      "channel" : 3,
      "currentPhrase" : 11,
      "instrumentName" : "viola",
      "nextPhraseStart" : 532
    },
    "b78de98e-0931-f1b7-7671-13874d030371" : {
      "advancePhrase" : 1,
      "channel" : 1,
      "currentPhrase" : 8,
      "instrumentName" : "acoustic_grand_piano",
      "nextPhraseStart" : 560
    },
    "e875f60e-cc39-3a6c-e306-f0d1f6ccde57" : {
      "advancePhrase" : 9,
      "channel" : 4,
      "currentPhrase" : 10,
      "instrumentName" : "marimba",
      "nextPhraseStart" : 550
    }
  };

  this.tempo = 240;
  firebase.database().ref("inC/tempo").set(this.tempo);
  this.performers = {};
  firebase.database().ref("inC/performers").set(this.performers);
  this.availableChannel = 1;
  firebase.database().ref("inC/availableChannel").set(this.availableChannel);

  this.newPerformer = function(id,instrument) {
    this.performers[id] = {
      "channel":this.availableChannel,
      "instrumentName":instrument,
      "currentPhrase":1,
      "nextPhraseStart":4,
      "advancePhrase":0
    };
    // Set up performer audio Channel
    MIDI.setVolume(this.availableChannel, 100);
    MIDI.programChange(this.availableChannel, MIDI.GM.byName[instrument].number);
    this.availableChannel += 1;
    firebase.database().ref("inC/availableChannel").set(this.availableChannel);
    firebase.database().ref("inC/performers").set(this.performers);
    this.setupPerformer(id);
  }

  this.setupPerformer = function(id) {
    $('.performers').append('<div class="player" id="' + id + '"><button class="advance">Advance</button><div class="current"><img src="./images/' + self.performers[id]['currentPhrase'] + '.png" /></div></div>');
    $('#' + id + ' .advance').click(function(e){
      e.preventDefault();
      self.advancePerformer(id);
    });
  };

  this.advancePerformer = function(id) {
    this.performers[id].advancePhrase += 1;
    firebase.database().ref("inC/performers").set(this.performers);
  };

  this.removePerformer = function(id) {
    delete this.performers[id];
    firebase.database().ref("inC/performers").set(this.performers);
  };

  this.init = function() {
    var eighthNoteMilliseconds = 60 * 1000 / this.tempo;

    MIDI.setVolume(0, 60);
    MIDI.programChange(0, MIDI.GM.byName["marimba"].number);

    var self = this;
    var beat = 0;

    var metronome = setInterval(function() {

      Object.keys(self.performers).forEach(function(key){
        if (self.performers[key].nextPhraseStart == beat) {
          if (self.performers[key].advancePhrase > 0) {
            self.performers[key].currentPhrase = self.performers[key].currentPhrase + 1;
            self.performers[key].advancePhrase = self.performers[key].advancePhrase - 1;
            $('#' + key + ' .current img').attr("src", "./images/" + self.performers[key].currentPhrase + ".png");
            if (self.performers[key].currentPhrase > 53) {
              self.removePerformer(key);
            }
          }
          var scoreIndex = (self.performers[key].currentPhrase - 1);
          var phraseScore = self.score[scoreIndex].score;
          var phraseInstructions = [];
          var phraseDuration = 0;
          var phraseNoteCount = phraseScore.length;
          var i = 0;

          phraseScore.forEach(function(note) {
            var duration = note.duration;
            var velocity = note.velocity;
            if (note.pitch) {
              var pitchValue = MIDI.keyToNote[note.pitch];
              var noteOn = {
                "type": "on",
                "channel": self.performers[key].channel,
                "pitch": pitchValue,
                "velocity": velocity,
                "duration": duration,
                "targetBeat": phraseDuration * 2,
                "delay": (phraseDuration * eighthNoteMilliseconds + 10) / 1000
              };
              phraseInstructions.push(noteOn);

              var noteOff = {
                "type":"off",
                "channel":self.performers[key].channel,
                "pitch":pitchValue,
                "duration": duration,
                "targetBeat": phraseDuration * 2,
                "delay": (phraseDuration * eighthNoteMilliseconds + (note.grace ? (eighthNoteMilliseconds / 4) : (duration * eighthNoteMilliseconds - 25))) / 1000
              };
              phraseInstructions.push(noteOff);
            }
            phraseDuration += duration;
          });
          self.performers[key].nextPhraseStart = beat + phraseDuration * 2;
          phraseInstructions.forEach(function(instruction) {
            if (instruction.type == "on") {
              MIDI.noteOn(instruction.channel, instruction.pitch, instruction.velocity, instruction.delay);
            } else {
              MIDI.noteOff(instruction.channel, instruction.pitch, instruction.delay);
            }
          });
        }
      });
      if (beat % 2 == 0) {
        MIDI.noteOn(0, 72, 100, 0);
        MIDI.noteOff(0, 72, 0.25);
      }
      beat += 1;
    }, eighthNoteMilliseconds / 2);
  }

  var self = this;
  $('.start').click(function(e){
    e.preventDefault();
    self.init();
  });

  $('.add').click(function(e){
    e.preventDefault();
    var insts = ["acoustic_grand_piano","marimba","oboe","viola"];
    var randInst = insts[Math.floor(Math.random()*insts.length)]
    function s4() {
      return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
    }
    var randName = s4() + s4() + '-' + s4() + '-' + s4() + '-' +
      s4() + '-' + s4() + s4() + s4();
    self.newPerformer(randName,randInst);
  });

  $('.sync').click(function(e){
    e.preventDefault();
    self.performers = self.performerMock;
    var syncOnPerformerKey = Object.keys(self.performers).reduce(function(a, b){ return self.performers[a]['nextPhraseStart'] > self.performers[b]['nextPhraseStart'] ? b : a });
    var normalizeToBeatNumber = self.performers[syncOnPerformerKey]['nextPhraseStart'];
    Object.keys(self.performers).forEach(function(performerId) {
      var performer = self.performers[performerId];
      self.performers[performerId]['nextPhraseStart'] = performer['nextPhraseStart'] - normalizeToBeatNumber + 4;
      self.setupPerformer(performerId);
      MIDI.setVolume(performer.channel, 100);
      MIDI.programChange(performer.channel, MIDI.GM.byName[performer.instrumentName].number);
    });
    firebase.database().ref("inC/performers").set(self.performers);
  });

};

$(document).ready(function() {
	MIDI.loadPlugin({
		soundfontUrl: "./audio/",
		instruments: [ "acoustic_grand_piano", "oboe", "viola", "marimba"],
		onsuccess: function() {
      window.inC = new inC();
		}
	});
});
